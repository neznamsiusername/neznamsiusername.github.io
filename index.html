<!DOCTYPE html>
<html lang="en">
<head>
  <!-- All head content is identical to your version -->
  <meta charset="UTF-8" />
  <meta name="theme-color" content="#1f1f1f">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>ChronosTrader AI</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    /* All CSS is identical to your version */
    :root {
      --body-bg: #121212; --bg: #121212; --header-bg: #121212; --input-bg: #1f1f1f;
      --suggestion-bg: #121212; --popup-bg: #121212; --popup-input-bg: #131313;
      --bubble-user: #3f3f46; --bubble-user-text: #e4e4e7; --bubble-assistant-text: #e4e4e7;
      --bubble-error-bg: #581c1c; --bubble-error-border: #f87171; --bubble-error-text: #fca5a5;
      --text: #e4e4e7; --text-muted: #a1a1aa; --accent: #10b981; --link-visited-color: #059669;
      --input-border: #4a4a4a; --input-border-focus: var(--accent); --button-disabled-bg: #52525b;
      --send-button-bg: var(--accent); --send-button-hover-bg: #0f9a6d; --send-button-icon: #ffffff;
      --scrollbar-thumb: #3a3a3a; --scrollbar-thumb-hover: #555555; --spinner-border: #52525b;
      --spinner-top: var(--accent); --textarea-scrollbar-thumb: #52525b; --textarea-scrollbar-track: var(--body-bg);
      --sidebar-width: 260px; --sidebar-bg: var(--body-bg); --sidebar-border: var(--input-bg);
      --conversation-hover-bg: var(--input-bg);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { height: 100%; }
    body { background: var(--body-bg); color: var(--text); font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; height: 100vh; overflow: hidden; }
    #sidebar { width: 0; background: var(--sidebar-bg); border-right: 1px solid var(--sidebar-border); display: flex; flex-direction: column; transition: width 0.3s ease; z-index: 40; flex-shrink: 0; overflow: hidden; height: 100%; }
    #sidebar.open { width: var(--sidebar-width); }
    #sidebar > * { opacity: 0; transition: opacity 0.2s ease; }
    #sidebar.open > * { opacity: 1; transition-delay: 0.15s; }
    .sidebar-header { padding: 10px 15px; border-bottom: 1px solid var(--sidebar-border); display: flex; align-items: center; justify-content: space-between; height: 55px; flex-shrink: 0; }
    .sidebar-logo-link { display: flex; align-items: center; color: var(--text-muted); transition: color 0.2s ease, transform 0.1s ease-out; }
    .sidebar-logo-link:hover { color: var(--accent); transform: scale(1.08); }
    .sidebar-logo-icon { width: 28px; height: 28px; }
    #sidebarCloseBtn { background: transparent; border: none; color: var(--text-muted); border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s, color 0.2s, transform 0.1s ease-out; padding: 0; }
    #sidebarCloseBtn:hover { background-color: var(--input-bg); color: var(--text); transform: scale(1.08); }
    #sidebarCloseBtn:active { transform: scale(0.95); }
    .sidebar-close-icon { width: 24px; height: 24px; display: block; }
    .sidebar-nav { padding: 10px; border-bottom: 1px solid var(--sidebar-border); }
    .new-chat-btn { display: flex; align-items: center; justify-content: center; width: 100%; padding: 10px; border-radius: 6px; background-color: var(--input-bg); color: var(--text); border: 1px solid var(--input-border); cursor: pointer; transition: background-color 0.2s, border-color 0.2s; font-size: 14px; gap: 8px; }
    .new-chat-btn:hover { background-color: var(--scrollbar-thumb); border-color: var(--accent); }
    .new-chat-btn .header-icon { width: 20px; height: 20px; }
    .sidebar-content { flex-grow: 1; overflow-y: auto; padding: 0; }
    .nav-title { display: flex; align-items: center; gap: 4px; padding: 15px 15px 5px; font-size: 12px; color: var(--text-muted); font-weight: 500; text-transform: uppercase; }
    .sidebar-content::-webkit-scrollbar { width: 6px; }
    .sidebar-content::-webkit-scrollbar-track { background: transparent; }
    .sidebar-content::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }
    .sidebar-content::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover); }
    #conversationsList { padding: 0 10px 10px; }
    .conversation-item { padding: 10px 15px; cursor: pointer; color: var(--text-muted); font-size: 14px; border-radius: 6px; transition: background .2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-bottom: none; }
    .conversation-item:hover, .conversation-item.active { background: var(--conversation-hover-bg); color: var(--text); }
    .conversation-item .conv-title { display: block; font-weight: 500; color: var(--text); margin-bottom: 3px;}
    .conversation-item .conv-date { font-size: 11px; }
    #main { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; transition: margin-left 0.3s ease; position: relative; }
    .header { background: var(--header-bg); padding: 0 16px; display: flex; justify-content: space-between; align-items: center; position: absolute; top: 0; left: 0; right: 0; z-index: 20; flex-shrink: 0; height: 55px; border-bottom: 1px solid transparent; transition: border-color 0.3s ease; }
    #main.chat-active .header { border-bottom: 1px solid var(--input-border); }
    .header .left-controls { display: flex; gap: 10px; align-items: center; }
    .header .right-controls { display: flex; align-items: center; gap: 8px; }
    .header button { background: transparent; border: none; color: var(--text-muted); padding: 8px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease-out; font-size: 14px; display: flex; align-items: center; justify-content: center; width: 38px; height: 38px; }
    .header button:hover { background: var(--input-bg); color: var(--text); transform: scale(1.03); }
    .header button:active { transform: scale(0.96); }
    .header-icon { width: 24px; height: 24px; display: block; }
    body.sidebar-open #sidebarOpenBtn { opacity: 0; visibility: hidden; pointer-events: none; width: 0; padding: 0; margin-left: -10px; }
    .messages-wrapper { flex-grow: 1; overflow-y: auto; background: var(--bg); padding: 16px; padding-top: 60px; position: relative; display: flex; flex-direction: column; }
    #main.chat-active .messages-wrapper { padding-bottom: 110px; }
    .messages { max-width: 945px; margin: 0 auto; display: flex; flex-direction: column; gap: 4px; padding-bottom: 10px; width: 100%; }
    .messages-wrapper::-webkit-scrollbar { width: 8px; }
    .messages-wrapper::-webkit-scrollbar-track { background: transparent; }
    .messages-wrapper::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 4px; }
    .messages-wrapper::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover); }
    #newChatSplash { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 20vh; text-align: center; flex-grow: 1; width: 100%; opacity: 0; transition: opacity 0.3s ease-out; pointer-events: none; }
    #main.splash-visible #newChatSplash { opacity: 1; pointer-events: auto; }
    .splash-logo-text { font-size: 3.5rem; font-weight: 600; letter-spacing: -1px; background: linear-gradient(90deg, var(--text), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 24px; }
    #splashInputArea { width: 100%; max-width: 995px; padding: 0 16px; }
    .suggestion-prompts-container { display: flex; flex-direction: column; gap: 8px; margin-top: 24px; align-items: center; max-width: 995px; width: 100%; padding: 0 16px; }
    .suggestion-prompts-line { display: flex; justify-content: center; width: 100%; gap: 8px; flex-wrap: wrap; }
    .suggestion-item { background-color: var(--suggestion-bg); border: 1px solid var(--input-border); color: var(--text-muted); padding: 8px 14px; border-radius: 8px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background-color 0.2s, border-color 0.2s, color 0.2s; text-decoration: none; justify-content: center; }
    .suggestion-item:hover { background-color: var(--scrollbar-thumb); border-color: var(--input-border-focus); color: var(--text); }
    .suggestion-item-icon { font-size: 16px; }
    .message { opacity: 0; transform: translateY(10px); animation: fadeInUp .3s forwards ease-out; position: relative; max-width: 90%; margin-bottom: 12px; display: flex; flex-direction: column; }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
    .message-footer { display: flex; align-items: center; gap: 8px; margin-top: 4px; padding: 0 5px; }
    .message.user .message-footer { justify-content: flex-end; }
    .message.assistant .message-footer, .message.error .message-footer { justify-content: flex-start; }
    .message .timestamp { font-size: 10px; color: var(--text-muted); }
    .message.user { align-self: flex-end; align-items: flex-end; }
    .message.user .message-content { display: flex; flex-direction: column; align-items: flex-end; }
    .message.user .message-bubble { background: var(--bubble-user); color: var(--bubble-user-text); padding: 10px 14px; border-radius: 16px; border-bottom-right-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.15); word-break: break-word; white-space: pre-wrap; width: fit-content; max-width: 100%; }
    .message.assistant { align-self: flex-start; align-items: flex-start;}
    .message.assistant .message-content { padding: 4px 0; color: var(--bubble-assistant-text); word-wrap: break-word; max-width: 100%; line-height: 1.5; }
    .chart-container { width: 100%; height: 450px; margin: 10px 0; border: 1px solid var(--input-border); border-radius: 8px; background-color: var(--input-bg); overflow: hidden; position: relative; }
    .message.assistant table { display: inline-block; max-width: 100%; overflow-x: auto; border-collapse: collapse; margin: 1em 0; border: 1px solid var(--input-border); border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); vertical-align: top; }
    .message.assistant th, .message.assistant td { padding: 10px 14px; border-bottom: 1px solid var(--input-border); text-align: left; white-space: nowrap; }
    .message.assistant thead th { background-color: var(--input-bg); font-weight: 600; color: var(--text); border-bottom: 2px solid var(--input-border-focus); }
    .message.assistant tbody tr:hover { background-color: var(--input-bg); }
    .message.assistant .message-content a { color: var(--accent); text-decoration: underline; }
    .message.assistant .message-content a:visited { color: var(--link-visited-color); }
    .message.error { align-self: flex-start; align-items: flex-start; }
    .message.error .message-content { padding: 10px 14px; border-radius: 8px; width: fit-content; color: var(--bubble-error-text); background: var(--bubble-error-bg); border: 1px solid var(--bubble-error-border); }
    .message.error .message-content strong { color: inherit; font-weight: 600; }
    .analyzing-indicator { margin-bottom: 12px; align-self: flex-start; animation: fadeInUp .3s forwards ease-out; display: flex; align-items: center; gap: 8px; }
    .typing { display: flex; gap: 5px; align-items: center; padding: 8px 0; }
    .typing-dot { width: 8px; height: 8px; background: var(--text-muted); border-radius: 50%; animation: blink 1.2s infinite ease-in-out; }
    .typing-dot:nth-child(2) { animation-delay: 0.15s; }
    .typing-dot:nth-child(3) { animation-delay: 0.3s; }
    @keyframes blink { 0%, 80%, 100% { opacity: .3; transform: scale(0.8); } 40% { opacity: 1; transform: scale(1); } }
    .analyzing-text { font-style: italic; color: var(--text-muted); }
    .input-area { position: absolute; left: 0; right: 0; bottom: 0; z-index: 30; padding: 8px 0; padding-bottom: calc(8px + env(safe-area-inset-bottom)); }
    #main.splash-visible .input-area { position: relative; bottom: auto; padding-bottom: 0; }
    .input-container { max-width: 995px; margin: 0 auto; padding: 0 16px; position: relative; left: -5px; }
    .input-inner form { display: flex; width: 100%; align-items: flex-end; gap: 6px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 24px; padding: 4px 4px 4px 16px; transition: border-color .2s; }
    .input-inner form:focus-within { border-color: var(--input-border-focus); }
    #chatInput { flex: 1; padding: 10px; border: none; background: transparent; color: var(--text); font-size: 14px; min-height: 40px; max-height: 150px; resize: none; line-height: 1.4; overflow-y: auto; }
    #chatInput:focus { outline: none; }
    #chatInput::placeholder { color: var(--text-muted); opacity: 0.7; }
    #sendBtn { width: 40px; height: 40px; background: var(--send-button-bg); border: none; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background .2s ease, opacity 0.2s ease, transform 0.1s ease-out; flex-shrink: 0; padding: 0; color: var(--send-button-icon); } 
    #sendBtn:disabled { background: var(--button-disabled-bg); opacity: .6; cursor: default; transform: scale(1); }
    #sendBtn:hover:not(:disabled) { background: var(--send-button-hover-bg); transform: scale(1.08); }
    .spinner { border: 3px solid var(--spinner-border); border-top: 3px solid var(--spinner-top); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #sendBtn.loading .send-icon { display: none; }
    .settings-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s linear; }
    .settings-popup.open { opacity: 1; visibility: visible; transition: opacity 0.3s ease, visibility 0s 0s linear; }
    .settings-popup-content { background: var(--popup-bg); padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 450px; color: var(--text); border: 1px solid var(--input-border); transform: scale(0.98); transition: opacity 0.2s ease, transform 0.2s ease; }
    .settings-popup.open .settings-popup-content { transform: scale(1); }
    .settings-popup-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--input-border); padding-bottom: 10px; margin-bottom: 15px; }
    .settings-popup-header h2 { margin: 0; font-size: 1.2em; color: var(--text); }
    .close-popup-btn { background: none; border: none; color: var(--text-muted); font-size: 24px; line-height: 1; cursor: pointer; padding: 0 5px; }
    .close-popup-btn:hover { color: var(--text); }
    .settings-popup-body label { display: block; margin-bottom: 5px; font-size: 14px; color: var(--text-muted); }
    .settings-popup-body input[type="text"] { width: 100%; padding: 8px 10px; border: 1px solid var(--input-border); border-radius: 6px; background: var(--popup-input-bg); color: var(--text); font-size: 14px; margin-bottom: 10px; }
    .settings-popup-body input[type="text"]:focus { outline: none; border-color: var(--input-border-focus); }
    .settings-note { font-size: 12px; color: var(--text-muted); margin-bottom: 15px; }
    .settings-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--input-border); }
    .settings-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0;}
    .settings-section h4 { font-size: 1em; color: var(--text); margin-bottom: 10px; }
    .settings-popup-footer { text-align: right; margin-top: 10px; }
    .settings-popup-body button, .settings-popup-footer button { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--input-border); background-color: #3a3a3a; color: var(--text); cursor: pointer; transition: background-color .2s, transform 0.1s ease-out; font-size: 13px; }
    .settings-popup-body button:hover, .settings-popup-footer button:hover { background-color: var(--scrollbar-thumb-hover); }
    .settings-popup-body button:active, .settings-popup-footer button:active { transform: scale(0.96); }
    .settings-popup-footer button { background: var(--accent); color: var(--send-button-icon); border: none; font-size: 14px; padding: 8px 15px; }
    .settings-popup-footer button:hover { background: var(--send-button-hover-bg); }
    .settings-danger-btn { background-color: #7f1d1d !important; border-color: #b91c1c !important; color: #fecaca !important; }
    .settings-danger-btn:hover { background-color: #991b1b !important; }
    @media (max-width: 768px) {
      :root { --sidebar-width: 220px; }
       #sidebar { position: fixed; top: 0; bottom: 0; left: 0; box-shadow: 2px 0 8px rgba(0,0,0,0.3); height: 100vh; }
       #sidebar.open { width: var(--sidebar-width); }
       #main { margin-left: 0 !important; width: 100%; }
       .messages, .input-container { max-width: 100%; padding: 0 10px; }
       .input-container { left: 0; }
       .splash-logo-text { font-size: 2.5rem; }
       .suggestion-prompts-line .suggestion-item { max-width: calc(50% - 4px); }
    }
    .mermaid-diagram-wrapper { display: inline-block; max-width: 100%; overflow: auto; max-height: 60vh; padding: 10px; margin: 10px 0; border: 1px solid var(--input-border); border-radius: 8px; background-color: rgba(0,0,0,0.2); vertical-align: top; }
    .mermaid-diagram-container { padding: 16px; margin: 0; display: flex; justify-content: flex-start; align-items: flex-start; background: transparent; min-width: 100%; width: max-content; }
    .mermaid-diagram-container svg { max-width: none !important; height: auto; }
  </style>
</head>
<body>
  <!-- All HTML structure is identical to your version -->
  <div id="sidebar">
      <div class="sidebar-header">
          <a href="#" class="sidebar-logo-link">
             <svg class="sidebar-logo-icon" viewBox="0 0 24 24" role="img" xmlns="http://www.w3.org/2000/svg" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M3 13l3 3l3-3l-3-3z"></path><path d="M7 17l4 4l4-4l-4-4z"></path><path d="M13 3l4 4l4-4l-4-4z"></path><path d="M6 10h1"></path><path d="M11 14h1"></path><path d="M17 7h1"></path></svg>
          </a>
          <button id="sidebarCloseBtn" title="Close History">
             <svg class="sidebar-close-icon" viewBox="0 0 1024 1024" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M861.866667 162.133333c-17.066667-17.066667-42.666667-29.866667-68.266667-29.866666H226.133333c-25.6 0-51.2 8.533333-68.266666 29.866666S128 204.8 128 230.4v567.466667c0 25.6 8.533333 51.2 29.866667 68.266666 17.066667 17.066667 42.666667 29.866667 68.266666 29.866667h567.466667c25.6 0 51.2-8.533333 68.266667-29.866667 17.066667-17.066667 29.866667-42.666667 29.866666-68.266666V226.133333c0-25.6-8.533333-46.933333-29.866666-64zM366.933333 814.933333H226.133333c-4.266667 0-8.533333 0-12.8-4.266666-4.266667-4.266667-4.266667-8.533333-4.266666-12.8V226.133333c0-4.266667 0-8.533333 4.266666-12.8 4.266667-4.266667 8.533333-4.266667 12.8-4.266666h140.8v605.866666z m448-17.066666c0 4.266667 0 8.533333-4.266666 12.8-4.266667 4.266667-8.533333 4.266667-12.8 4.266666h-354.133334V209.066667h354.133334c4.266667 0 8.533333 0 12.8 4.266666 4.266667 4.266667 4.266667 8.533333 4.266666 12.8v571.733334z"></path></svg>
         </button>
      </div>
      <div class="sidebar-nav">
        <button id="newChatBtn" class="new-chat-btn">
            <svg class="header-icon" viewBox="0 0 1024 1024" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M475.136 561.152v89.74336c0 20.56192 16.50688 37.23264 36.864 37.23264s36.864-16.67072 36.864-37.23264v-89.7024h89.7024c20.60288 0 37.2736-16.54784 37.2736-36.864 0-20.39808-16.67072-36.864-37.2736-36.864H548.864V397.63968A37.0688 37.0688 0 0 0 512 360.448c-20.35712 0-36.864 16.67072-36.864 37.2736v89.7024H385.4336a37.0688 37.0688 0 0 0-37.2736 36.864c0 20.35712 16.67072 36.864 37.2736 36.864h89.7024z"></path><path d="M512 118.784c-223.96928 0-405.504 181.57568-405.504 405.504 0 78.76608 22.44608 152.3712 61.35808 214.6304l-44.27776 105.6768a61.44 61.44 0 0 0 56.68864 85.1968H512c223.92832 0 405.504-181.53472 405.504-405.504 0-223.92832-181.57568-405.504-405.504-405.504z m-331.776 405.504a331.776 331.776 0 1 1 331.73504 331.776H198.656l52.59264-125.5424-11.59168-16.62976A330.09664 330.09664 0 0 1 180.224 524.288z" fill="currentColor"></path></svg>
            <span>New Analysis</span>
        </button>
      </div>
     <div class="sidebar-content">
        <div class="nav-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 1024 1024"><path d="M512 81.066667c-233.301333 0-422.4 189.098667-422.4 422.4s189.098667 422.4 422.4 422.4 422.4-189.098667 422.4-422.4-189.098667-422.4-422.4-422.4z m-345.6 422.4a345.6 345.6 0 1 1 691.2 0 345.6 345.6 0 1 1-691.2 0z m379.733333-174.933334a38.4 38.4 0 0 0-76.8 0v187.733334a38.4 38.4 0 0 0 11.264 27.136l93.866667 93.866666a38.4 38.4 0 1 0 54.272-54.272L546.133333 500.352V328.533333z" fill="currentColor"></path></svg>
            <span>Analysis History</span>
        </div>
        <div id="conversationsList"></div>
     </div>
  </div>
  <div id="main">
    <div class="header">
       <div class="left-controls">
            <button id="sidebarOpenBtn" title="Open History"><svg class="header-icon" viewBox="0 0 1024 1024" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M861.866667 162.133333c-17.066667-17.066667-42.666667-29.866667-68.266667-29.866666H226.133333c-25.6 0-51.2 8.533333-68.266666 29.866666S128 204.8 128 230.4v567.466667c0 25.6 8.533333 51.2 29.866667 68.266666 17.066667 17.066667 42.666667 29.866667 68.266666 29.866667h567.466667c25.6 0 51.2-8.533333 68.266667-29.866667 17.066667-17.066667 29.866667-42.666667 29.866666-68.266666V226.133333c0-25.6-8.533333-46.933333-29.866666-64zM366.933333 814.933333H226.133333c-4.266667 0-8.533333 0-12.8-4.266666-4.266667-4.266667-4.266667-8.533333-4.266666-12.8V226.133333c0-4.266667 0-8.533333 4.266666-12.8 4.266667-4.266667 8.533333-4.266667 12.8-4.266666h140.8v605.866666z m448-17.066666c0 4.266667 0 8.533333-4.266666 12.8-4.266667 4.266667-8.533333 4.266667-12.8 4.266666h-354.133334V209.066667h354.133334c4.266667 0 8.533333 0 12.8 4.266666 4.266667 4.266667 4.266667 8.533333 4.266666 12.8v571.733334z"></path></svg></button>
       </div>
       <div class="right-controls">
           <button id="settingsBtn" title="Settings"><svg class="header-icon" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg></button>
       </div>
    </div>
    <div class="messages-wrapper" id="messagesWrapper">
        <div class="messages" id="messagesContainer"></div>
        <div id="newChatSplash">
            <h1 class="splash-logo-text">ChronosTrader AI</h1>
            <div id="splashInputArea"></div>
            <div class="suggestion-prompts-container" id="suggestionPrompts"></div>
        </div>
    </div>
    <div class="input-area" id="inputArea">
      <div class="input-container">
        <div class="input-inner">
          <form id="chatForm">
            <textarea id="chatInput" placeholder="Ask to chart a ticker or explain a strategy..." rows="1"></textarea>
            <button type="submit" id="sendBtn" disabled><div id="sendBtnContent"><div class="send-icon"><div class="ds-icon"><svg width="14" height="16" viewBox="0 0 14 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 16c-.595 0-1.077-.462-1.077-1.032V1.032C5.923.462 6.405 0 7 0s1.077.462 1.077 1.032v13.936C8.077 15.538 7.595 16 7 16z" fill="currentColor"></path><path d="M.315 7.44a1.002 1.002 0 0 1 0-1.46L6.238.302a1.11 1.11 0 0 1 1.523 0c.421.403.421 1.057 0 1.46L1.838 7.44a1.11 1.11 0 0 1-1.523 0z" fill="currentColor"></path><path d="M13.685 7.44a1.11 1.11 0 0 1-1.523 0L6.238 1.762a1.002 1.002 0 0 1 0-1.46 1.11 1.11 0 0 1 1.523 0l5.924 5.678c.42.403.42 1.056 0 1.46z" fill="currentColor"></path></svg></div></div></div></button>
          </form>
        </div>
      </div>
    </div>
  </div> 
  <div id="settingsPopup" class="settings-popup">
      <div class="settings-popup-content">
          <div class="settings-popup-header">
              <h2>Settings</h2>
              <button id="closeSettingsPopupBtn" class="close-popup-btn" title="Close settings">×</button>
          </div>
          <div class="settings-popup-body">
              <div class="settings-section">
                <h4>User Profile</h4>
                <label for="userNameInput">Your Name:</label>
                <input type="text" id="userNameInput" placeholder="Enter your name">
                <p class="settings-note">This name will be used to inform the AI at the start of new analyses.</p>
              </div>
              <div class="settings-section">
                <h4>Data Management</h4>
                <button id="clearAllChatsBtn" class="settings-danger-btn">Clear All Analysis History</button>
                <p class="settings-note">This will permanently delete all your saved analyses.</p>
              </div>
          </div>
          <div class="settings-popup-footer"> <button id="saveSettingsBtn">Save Settings</button> </div>
      </div>
  </div>

  <script>
    const BACKEND_URL = "https://chronostrader.onrender.com/chat";
    const CONVERSATION_PREFIX = 'ct_history_';
    const USER_NAME_KEY = 'ct_userName_v1';
    const MAX_TITLE_LENGTH = 40;

    const bodyEl = document.body;
    const mainEl = document.getElementById('main');
    const sidebar = document.getElementById('sidebar');
    const sidebarOpenBtn = document.getElementById('sidebarOpenBtn');
    const sidebarCloseBtn = document.getElementById('sidebarCloseBtn');
    const conversationsList = document.getElementById('conversationsList');
    const newChatBtn = document.getElementById('newChatBtn');
    const messagesWrapper = document.getElementById('messagesWrapper');
    const messagesContainer = document.getElementById('messagesContainer');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const sendBtnContent = document.getElementById('sendBtnContent');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsPopup = document.getElementById('settingsPopup');
    const closeSettingsPopupBtn = document.getElementById('closeSettingsPopupBtn');
    const userNameInput = document.getElementById('userNameInput');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const clearAllChatsBtn = document.getElementById('clearAllChatsBtn');
    const inputArea = document.getElementById('inputArea');
    const splashInputArea = document.getElementById('splashInputArea');
    const suggestionPromptsContainer = document.getElementById('suggestionPrompts');

    let isSending = false;
    let currentConversationId = null;
    let currentHistory = [];

    const allSuggestionPrompts = [
        { icon: '📈', summary: "Chart NVDA with MAs", full: "Plot a chart for NVDA over the last year with the 50 and 200 day moving averages" },
        { icon: '⛓️', summary: 'Get TSLA options', full: "Show me the options chain for Tesla" },
        { icon: '📰', summary: "Check economic calendar", full: "Are there any high-impact news events today?" },
        { icon: '💡', summary: 'Explain a strategy', full: "Explain a simple moving average crossover strategy using a flowchart" },
    ];

    function populateSuggestionPrompts() {
        suggestionPromptsContainer.innerHTML = '';
        const promptsToDisplay = [ allSuggestionPrompts.slice(0, 2), allSuggestionPrompts.slice(2, 4) ];
        promptsToDisplay.forEach(linePrompts => {
            const lineDiv = document.createElement('div');
            lineDiv.className = 'suggestion-prompts-line';
            linePrompts.forEach(prompt => {
                const item = document.createElement('a');
                item.className = 'suggestion-item';
                item.href = '#';
                item.innerHTML = `<span class="suggestion-item-icon">${prompt.icon}</span> ${prompt.summary}`;
                item.addEventListener('click', (e) => { e.preventDefault(); if (isSending) return; chatInput.value = prompt.full; sendMessage(); });
                lineDiv.appendChild(item);
            });
            suggestionPromptsContainer.appendChild(lineDiv);
        });
    }
    
    const getTimestamp = () => new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const scrollChatToBottom = (behavior = 'smooth') => setTimeout(() => { messagesWrapper.scrollTo({ top: messagesWrapper.scrollHeight, behavior }); }, 50);
    const simpleSanitize = (str) => typeof str === 'string' ? str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';
    
    function renderMarkdown(text) {
        marked.setOptions({ gfm: true, breaks: true });
        const dirtyHtml = marked.parse(text);
        return DOMPurify.sanitize(dirtyHtml);
    }

    function renderTradingChart(container, chartJson) {
        if (chartJson && chartJson.error) {
            container.innerHTML = `<p style="padding: 15px; color: var(--bubble-error-text);">${simpleSanitize(chartJson.error)}</p>`;
            return;
        }
        if (!window.LightweightCharts || !container || !chartJson || !chartJson.data) {
            container.innerHTML = "<p style='padding: 15px;'>Error: Invalid chart data received.</p>";
            return;
        }
        const chartOptions = { layout: { background: { color: 'transparent' }, textColor: getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim(), }, grid: { vertLines: { color: 'rgba(255, 255, 255, 0.1)' }, horzLines: { color: 'rgba(255, 255, 255, 0.1)' }, }, crosshair: { mode: LightweightCharts.CrosshairMode.Normal }, rightPriceScale: { borderColor: 'rgba(255, 255, 255, 0.2)' }, timeScale: { borderColor: 'rgba(255, 255, 255, 0.2)' }, };
        const chart = LightweightCharts.createChart(container, chartOptions);
        const candleSeries = chart.addCandlestickSeries({ upColor: '#26a69a', downColor: '#ef5350', borderVisible: false, wickUpColor: '#26a69a', wickDownColor: '#ef5350', });
        candleSeries.setData(chartJson.data);
        const maColors = ['#2962FF', '#FF6D00', '#9C27B0'];
        if (chartJson.mas) {
            Object.keys(chartJson.mas).forEach((key, index) => {
                const maSeries = chart.addLineSeries({ color: maColors[index % maColors.length], lineWidth: 2, priceLineVisible: false, lastValueVisible: false, });
                maSeries.setData(chartJson.mas[key]);
            });
        }
        chart.timeScale().fitContent();
        new ResizeObserver(entries => {
            if (entries.length === 0 || entries[0].target !== container) { return; }
            const { width, height } = entries[0].contentRect;
            chart.applyOptions({ width, height });
        }).observe(container);
    }

    function createMessageElement(role, textContent = '', timestamp = null, animate = true) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        const messageContentDiv = document.createElement('div');
        messageContentDiv.className = 'message-content';
        if (role === 'user') {
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.innerHTML = simpleSanitize(textContent).replace(/\r\n|\r|\n/g, '<br>');
            messageContentDiv.appendChild(bubble);
        } else if (role === 'error') {
            messageContentDiv.innerHTML = `<strong>Error:</strong> ${simpleSanitize(textContent)}`;
        } else {
            messageContentDiv.innerHTML = renderMarkdown(textContent);
        }
        messageDiv.appendChild(messageContentDiv);
        const footerDiv = document.createElement('div');
        footerDiv.className = 'message-footer';
        const tsDiv = document.createElement('div');
        tsDiv.className = 'timestamp';
        tsDiv.textContent = timestamp || getTimestamp();
        footerDiv.appendChild(tsDiv);
        messageDiv.appendChild(footerDiv);
        messagesContainer.appendChild(messageDiv);
        if (animate) {
            messageDiv.style.opacity = '0';
            messageDiv.style.transform = 'translateY(10px)';
            requestAnimationFrame(() => { messageDiv.style.opacity = '1'; messageDiv.style.transform = 'translateY(0)'; });
        }
        scrollChatToBottom();
        return { messageElement: messageDiv, contentElement: messageContentDiv };
    }

    function showAnalyzingIndicator(toolName) {
        removeAnalyzingIndicator();
        const indicatorDiv = createMessageElement('assistant', `<div class="typing"><span class="typing-dot"></span></div> <span class="analyzing-text">Analyzing with ${toolName}...</span>`, getTimestamp()).messageElement;
        indicatorDiv.classList.add('analyzing-indicator');
    }
    const removeAnalyzingIndicator = () => messagesContainer.querySelector('.analyzing-indicator')?.remove();

    const saveCurrentConversation = () => {
        if (currentHistory.length < 1) return;
        const title = getConversationTitle(currentHistory);
        const id = currentConversationId || `${CONVERSATION_PREFIX}${Date.now()}`;
        const conversation = { id, title, date: Date.now(), history: currentHistory };
        localStorage.setItem(id, JSON.stringify(conversation));
        currentConversationId = id;
        loadConversationsList();
    };

    const getConversationTitle = (history) => {
        const firstUserMessage = history.find(m => m.role === 'user');
        let title = firstUserMessage ? firstUserMessage.parts[0].text : "New Analysis";
        return title.length > MAX_TITLE_LENGTH ? title.substring(0, MAX_TITLE_LENGTH) + '...' : title;
    };

    const loadConversationsList = () => {
        const keys = Object.keys(localStorage).filter(k => k.startsWith(CONVERSATION_PREFIX));
        const chats = keys.map(key => JSON.parse(localStorage.getItem(key))).sort((a, b) => b.date - a.date);
        conversationsList.innerHTML = chats.length === 0 ? '<div style="padding: 15px; color: var(--text-muted); font-size: 13px; text-align: center;">No past analyses.</div>' : '';
        chats.forEach(chat => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'conversation-item';
            itemDiv.dataset.id = chat.id;
            itemDiv.innerHTML = `<span class="conv-title">${simpleSanitize(chat.title)}</span><span class="conv-date">${new Date(chat.date).toLocaleString()}</span>`;
            itemDiv.addEventListener('click', () => loadConversation(chat.id));
            conversationsList.appendChild(itemDiv);
        });
        document.querySelectorAll('.conversation-item').forEach(item => item.classList.toggle('active', item.dataset.id === currentConversationId));
    };

    const loadConversation = (id) => {
        const data = JSON.parse(localStorage.getItem(id));
        if (!data) return startNewConversation();
        currentConversationId = id;
        currentHistory = data.history;
        messagesContainer.innerHTML = '';
        currentHistory.forEach(msg => {
            const role = msg.role === 'model' ? 'assistant' : 'user';
            createMessageElement(role, msg.parts[0].text, null, false);
        });
        mainEl.classList.add('chat-active');
        mainEl.classList.remove('splash-visible');
        mainEl.appendChild(inputArea);
        loadConversationsList();
        setTimeout(() => {
            document.querySelectorAll('.message.assistant .message-content').forEach(contentEl => {
                if (contentEl.innerText.includes('[Chart for')) {
                }
                if (contentEl.innerText.includes('[flowchart]')) {
                    const flowchartMatch = contentEl.innerText.match(/\[flowchart\]\s*```([\s\S]*?)```\s*\[\/flowchart\]/);
                    if (flowchartMatch && flowchartMatch[1]) {
                        const mermaidCode = flowchartMatch[1].trim();
                        const textOnly = contentEl.innerText.replace(flowchartMatch[0], '');
                        contentEl.innerHTML = renderMarkdown(textOnly);
                        const mermaidContainer = document.createElement('div');
                        mermaidContainer.className = 'mermaid-diagram-wrapper';
                        mermaidContainer.innerHTML = `<div class="mermaid-diagram-container"><div class="mermaid">${mermaidCode}</div></div>`;
                        contentEl.appendChild(mermaidContainer);
                        try { mermaid.run({ nodes: mermaidContainer.querySelectorAll('.mermaid') }); } catch (e) {}
                    }
                }
            });
        }, 100);
    };

    const startNewConversation = () => {
        if (currentHistory.length > 0) saveCurrentConversation();
        currentConversationId = null;
        currentHistory = [];
        messagesContainer.innerHTML = '';
        mainEl.classList.add('splash-visible');
        mainEl.classList.remove('chat-active');
        splashInputArea.appendChild(inputArea);
        populateSuggestionPrompts();
        loadConversationsList();
    };

    async function sendMessage() {
        const userInput = chatInput.value.trim();
        if (userInput === '' || isSending) return;

        isSending = true;
        chatInput.value = '';
        updateSendButtonState();
        mainEl.classList.add('chat-active');
        mainEl.classList.remove('splash-visible');
        mainEl.appendChild(inputArea);

        createMessageElement('user', userInput);
        currentHistory.push({ role: 'user', parts: [{ text: userInput }] });
        
        let accumulatedText = "";
        let assistantMessageWrapper;
        let assistantContentDiv;

        try {
            const formData = new FormData();
            formData.append('prompt', userInput);
            formData.append('history', JSON.stringify(currentHistory.slice(0, -1)));

            const response = await fetch(BACKEND_URL, { method: 'POST', body: formData });
            if (!response.ok || !response.body) throw new Error(`HTTP error! status: ${response.status}`);

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                const chunkStr = decoder.decode(value, { stream: true });
                const eventLines = chunkStr.split('\n\n').filter(line => line.trim());

                for (const line of eventLines) {
                    if (line.startsWith('event: tool_started')) {
                        const dataJson = line.substring(line.indexOf('data: ') + 6);
                        const data = JSON.parse(dataJson);
                        showAnalyzingIndicator(data.tool_name);
                    } else if (line.startsWith('event: chart_data_generated')) {
                        removeAnalyzingIndicator();
                        if (!assistantMessageWrapper) {
                            const result = createMessageElement('assistant', '');
                            assistantMessageWrapper = result.messageElement;
                            assistantContentDiv = result.contentElement;
                        }
                        
                        // --- THE ROBUST JSON FIX IS HERE ---
                        const dataJson = line.substring(line.indexOf('data: ') + 6);
                        const eventPayload = JSON.parse(dataJson);
                        const chartJson = eventPayload.chart_data;
                        // --- END OF FIX ---

                        const chartContainer = document.createElement('div');
                        chartContainer.className = 'chart-container';
                        assistantContentDiv.appendChild(chartContainer);
                        renderTradingChart(chartContainer, chartJson);
                        
                        if (!chartJson.error) {
                            currentHistory.push({ role: 'model', parts: [{ text: `[Chart for ${chartJson.ticker || 'symbol'} was generated]` }] });
                        } else {
                            currentHistory.push({ role: 'model', parts: [{ text: `[Chart generation failed: ${chartJson.error}]` }] });
                        }
                    } else if (line.startsWith('event: content_chunk')) {
                        removeAnalyzingIndicator();
                        if (!assistantMessageWrapper) {
                            const result = createMessageElement('assistant', '');
                            assistantMessageWrapper = result.messageElement;
                            assistantContentDiv = result.contentElement;
                        }
                        const dataJson = line.substring(line.indexOf('data: ') + 6);
                        const data = JSON.parse(dataJson);
                        accumulatedText += data.text_chunk;
                        assistantContentDiv.innerHTML = renderMarkdown(accumulatedText);
                        scrollChatToBottom();
                    } else if (line.startsWith('event: stream_error')) {
                        const dataJson = line.substring(line.indexOf('data: ') + 6);
                        const data = JSON.parse(dataJson);
                        throw new Error(data.error);
                    }
                }
            }
        } catch (error) {
            removeAnalyzingIndicator();
            createMessageElement('error', error.message);
        } finally {
            isSending = false;
            updateSendButtonState();
            removeAnalyzingIndicator();

            if (accumulatedText) {
                if (accumulatedText.includes('[flowchart]')) {
                    const flowchartMatch = accumulatedText.match(/\[flowchart\]\s*```([\s\S]*?)```\s*\[\/flowchart\]/);
                    if (flowchartMatch && flowchartMatch[1] && assistantContentDiv) {
                        const mermaidCode = flowchartMatch[1].trim();
                        const textOnly = accumulatedText.replace(flowchartMatch[0], '');
                        assistantContentDiv.innerHTML = renderMarkdown(textOnly);
                        const mermaidContainer = document.createElement('div');
                        mermaidContainer.className = 'mermaid-diagram-wrapper';
                        mermaidContainer.innerHTML = `<div class="mermaid-diagram-container"><div class="mermaid">${mermaidCode}</div></div>`;
                        assistantContentDiv.appendChild(mermaidContainer);
                        try { mermaid.run({ nodes: mermaidContainer.querySelectorAll('.mermaid') }); } catch (e) { console.error("Mermaid rendering error:", e); }
                    }
                }
                currentHistory.push({ role: 'model', parts: [{ text: accumulatedText }] });
            }
            saveCurrentConversation();
        }
    }

    const updateSendButtonState = () => {
        const hasContent = chatInput.value.trim() !== '';
        sendBtn.disabled = isSending || !hasContent;
        if (isSending) {
            sendBtn.classList.add('loading');
            sendBtnContent.innerHTML = '<div class="spinner"></div>';
        } else {
            sendBtn.classList.remove('loading');
            sendBtnContent.innerHTML = `<div class="send-icon"><div class="ds-icon"><svg width="14" height="16" viewBox="0 0 14 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 16c-.595 0-1.077-.462-1.077-1.032V1.032C5.923.462 6.405 0 7 0s1.077.462 1.077 1.032v13.936C8.077 15.538 7.595 16 7 16z" fill="currentColor"></path><path d="M.315 7.44a1.002 1.002 0 0 1 0-1.46L6.238.302a1.11 1.11 0 0 1 1.523 0c.421.403.421 1.057 0 1.46L1.838 7.44a1.11 1.11 0 0 1-1.523 0z" fill="currentColor"></path><path d="M13.685 7.44a1.11 1.11 0 0 1-1.523 0L6.238 1.762a1.002 1.002 0 0 1 0-1.46 1.11 1.11 0 0 1 1.523 0l5.924 5.678c.42.403.42 1.056 0 1.46z" fill="currentColor"></path></svg></div></div>`;
        }
    };
    
    const adjustTextareaHeight = () => {
        chatInput.style.height = 'auto';
        chatInput.style.height = `${chatInput.scrollHeight}px`;
    };

    chatInput.addEventListener('input', () => { updateSendButtonState(); adjustTextareaHeight(); });
    chatForm.addEventListener('submit', (e) => { e.preventDefault(); sendMessage(); });
    chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    newChatBtn.addEventListener('click', startNewConversation);
    
    sidebarOpenBtn.addEventListener('click', () => { sidebar.classList.add('open'); bodyEl.classList.add('sidebar-open'); });
    sidebarCloseBtn.addEventListener('click', () => { sidebar.classList.remove('open'); bodyEl.classList.remove('sidebar-open'); });
    document.addEventListener('click', (e) => { 
        if (window.innerWidth <= 768 && sidebar.classList.contains('open') && !sidebar.contains(e.target) && !sidebarOpenBtn.contains(e.target)) {
            sidebar.classList.remove('open');
            bodyEl.classList.remove('sidebar-open');
        } 
    });

    settingsBtn.addEventListener('click', () => settingsPopup.classList.add('open'));
    closeSettingsPopupBtn.addEventListener('click', () => settingsPopup.classList.remove('open'));
    settingsPopup.addEventListener('click', (e) => { if (e.target === settingsPopup) settingsPopup.classList.remove('open'); });
    saveSettingsBtn.addEventListener('click', () => {
        localStorage.setItem(USER_NAME_KEY, userNameInput.value.trim());
        settingsPopup.classList.remove('open');
    });
    clearAllChatsBtn.addEventListener('click', () => {
        if (confirm("Are you sure? This will delete all analysis history.")) {
            Object.keys(localStorage).filter(k => k.startsWith(CONVERSATION_PREFIX)).forEach(k => localStorage.removeItem(k));
            startNewConversation();
            settingsPopup.classList.remove('open');
        }
    });

    function initializeApp() {
        userNameInput.value = localStorage.getItem(USER_NAME_KEY) || '';
        startNewConversation();
        updateSendButtonState();
        adjustTextareaHeight();
        mermaid.initialize({ startOnLoad: false, theme: 'base', fontFamily: 'Segoe UI', themeVariables: { background: '#121212', primaryColor: '#1f1f1f', primaryTextColor: '#e4e4e7', primaryBorderColor: '#10b981', lineColor: '#4a4a4a', secondaryColor: '#3f3f36', tertiaryColor: '#1f1f1f' } });
    }

    initializeApp();
  </script>
</body>
</html>
